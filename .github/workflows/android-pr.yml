name: Beagle Android Pull Request

on:
    push:
        branches:
            - main
        paths:
            - 'android/**'
    pull_request:
        paths:
            - 'android/**'
            - 'Gemfile'

jobs:
    pr-verification:
        name: PR Check Android
        runs-on: macos-latest
        steps:
            -   uses: actions/checkout@v2

            # Gems for Fastlane
            -   name: Cache ruby gems dependencies
                uses: actions/cache@v2
                env:
                    keyPath: ${{ runner.os }}-gems
                with:
                    path: ~/.gem
                    key: ${{ env.keyPath }}-${{ hashFiles('Gemfile.lock') }}
                    restore-keys: ${{ env.keyPath }}
            -   name: Install gem dependencies
                run: bundle config set path '~/.gem' && bundle install

            -   name: Cache gradle dependences
                uses: actions/cache@v2
                env:
                    gradle-cache-key: gradle-cache-android
                    gradle-path: ~/.gradle
                with:
                    path: ${{ env.gradle-path }}
                    key: ${{ runner.os }}-build-${{ env.gradle-cache-key }}-${{ hashFiles('android/buildSrc/**') }}
                    restore-keys: ${{ runner.os }}-build-${{ env.gradle-cache-key }}
            - name: Read secrets from AWS Secrets Manager into environment variables
              uses: abhilash1in/aws-secrets-manager-action@v1.0.1
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: us-east-1
                  secrets: |
                      beagle/helpers/*
                      beagle/core/github
                      beagle/core/artifact
                  parse-json: true
            -   name: Check if env variable is set after fetching secrets
                env:
                    GITHUB_USER: ${BEAGLE_CORE_GITHUB_GITHUB_USER}
                    GITHUB_TOKEN: ${BEAGLE_CORE_GITHUB_GITHUB_TOKEN}
                run: if [ -z ${GITHUB_USER+x} ]; then echo "GITHUB_USER is unset"; else echo "GITHUB_USER is set to '$GITHUB_USER'"; fi

            -   name: Run pr check
                env:
                    GITHUB_USER: ${BEAGLE_CORE_GITHUB_GITHUB_USER}
                    GITHUB_TOKEN: ${BEAGLE_CORE_GITHUB_GITHUB_TOKEN}
                run: bundle exec fastlane android pull_request_verification
